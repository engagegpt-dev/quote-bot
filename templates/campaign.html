{% extends "base.html" %}

{% block title %}Campaign - Quote Bot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-rocket"></i> Start Quote Campaign</h5>
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}

                {% if is_running %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Campaign is currently running. Stop it first to start a new one.
                </div>
                {% endif %}

                <form method="post" action="/campaign/start" {% if is_running %}style="opacity: 0.5; pointer-events: none;"{% endif %}>
                    <div class="mb-3">
                        <label class="form-label">Tweet URL</label>
                        <input type="url" class="form-control" name="tweet_url" 
                               placeholder="https://x.com/username/status/123456789" required>
                        <div class="form-text">Full URL of the tweet to quote retweet</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Users to Tag</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="users_to_tag" id="users_input"
                                   placeholder="user1, user2, user3" required>
                            <button type="button" class="btn btn-outline-secondary" id="import_file_btn">
                                <i class="fas fa-file-upload"></i> Import File
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#scrapingModal">
                                <i class="fas fa-users"></i> Scrape Followers
                            </button>
                        </div>
                        <input type="file" id="file_input" accept=".txt,.csv" style="display: none;">
                        
                        <div class="form-text">
                            Comma-separated list of usernames to tag (without @)<br>
                            <small class="text-success">‚ú® <strong>Unlimited users supported!</strong> Duplicates automatically removed. Large lists split into multiple posts (max 10 tags each)</small>
                        </div>
                        
                        <div class="mt-2" id="batch_info" style="display: none;">
                            <div class="alert alert-info small">
                                <i class="fas fa-info-circle"></i>
                                <span id="batch_details"></span>
                            </div>
                        </div>
                        
                        <div class="mt-2" id="duplicates_info" style="display: none;">
                            <div class="alert alert-warning small">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span id="duplicates_details"></span>
                            </div>
                        </div>
                        
                        <div class="mt-2">
                            <small class="text-muted">Available tags:</small>
                            <div id="available_tags" class="mt-1"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Message Template <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="message" id="message_template" rows="4" required
                                  placeholder="üî• Don't miss your chance to join the WET airdrop! #WET #SOL&#10;https://x.com/i/communities/1998500948134559892 $WET&#10;&#10;ü™Ç eligible users: {TAGS}"></textarea>
                        <div class="form-text">
                            <strong>Minimum 80 characters required</strong> to avoid AI detection.<br>
                            Use <code>{TAGS}</code> placeholder where you want the tagged users to appear.
                            <br><small class="text-muted">Drag tags from above into the message or type {TAGS} manually.</small>
                        </div>
                        
                        <div class="mt-1">
                            <small class="text-muted">Character count: <span id="char_count" class="text-danger">0</span>/80 minimum</small>
                        </div>
                        
                        <div class="mt-2">
                            <small class="text-muted">Quick Templates:</small>
                            <div class="row mt-1">
                                <div class="col-md-4">
                                    <div class="card template-card" style="cursor: pointer; border: 2px solid #e9ecef;">
                                        <div class="card-body p-2 text-center">
                                            <div class="template-emoji">üöÄüíé</div>
                                            <small class="text-muted">Community Update</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card template-card" style="cursor: pointer; border: 2px solid #e9ecef;">
                                        <div class="card-body p-2 text-center">
                                            <div class="template-emoji">üéâüéÅ</div>
                                            <small class="text-muted">Appreciation</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card template-card" style="cursor: pointer; border: 2px solid #e9ecef;">
                                        <div class="card-body p-2 text-center">
                                            <div class="template-emoji">üî•‚ö°</div>
                                            <small class="text-muted">Discussion</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-2">
                            <small class="text-muted">Preview:</small>
                            <div id="message_preview" class="border rounded p-2 bg-light small" style="min-height: 60px;"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Select Accounts</label>
                        {% if accounts %}
                        <div class="row">
                            {% for account in accounts %}
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="account_ids" 
                                           value="{{ account.id }}" id="account{{ account.id }}" checked>
                                    <label class="form-check-label" for="account{{ account.id }}">
                                        @{{ account.username }}
                                        {% if account.get('verified') %}
                                        <i class="fas fa-check-circle text-primary" title="Verified account"></i>
                                        {% endif %}
                                        <small class="text-muted">({{ account.registration_year }})</small>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectVerifiedOnly()">
                                <i class="fas fa-check-circle"></i> Select Verified Only
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllAccounts()">
                                <i class="fas fa-users"></i> Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="deselectAllAccounts()">
                                <i class="fas fa-times"></i> Deselect All
                            </button>
                        </div>
                        <div class="form-text">Select which accounts to use for the campaign</div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            No active accounts available. <a href="/accounts">Add accounts first</a>.
                        </div>
                        {% endif %}
                    </div>

                    {% if accounts and not is_running %}
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-rocket"></i> Start Campaign
                    </button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> Campaign Info</h6>
            </div>
            <div class="card-body">
                <p><strong>How it works:</strong></p>
                <ol class="small">
                    <li>Bot logs into selected accounts</li>
                    <li>Navigates to the tweet URL</li>
                    <li>Creates quote retweet</li>
                    <li>Tags specified users</li>
                    <li>Adds optional message</li>
                    <li>Posts the quote</li>
                </ol>

                <div class="alert alert-info small">
                    <i class="fas fa-users"></i>
                    <strong>Batch Processing:</strong><br>
                    ‚Ä¢ Max 10 tags per post<br>
                    ‚Ä¢ Multiple posts for large lists<br>
                    ‚Ä¢ 1-2 min delay between posts
                </div>
                
                <div class="alert alert-success small">
                    <i class="fas fa-magic"></i>
                    <strong>Smart Features:</strong><br>
                    ‚Ä¢ Auto-splits large tag lists<br>
                    ‚Ä¢ Cycles through accounts<br>
                    ‚Ä¢ Handles unlimited users
                </div>

                <div class="alert alert-warning small">
                    <i class="fas fa-exclamation-triangle"></i>
                    Monitor logs for any issues
                </div>
            </div>
        </div>

        {% if accounts %}
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-users"></i> Available Accounts</h6>
            </div>
            <div class="card-body">
                {% for account in accounts %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>@{{ account.username }}</span>
                    <span class="badge bg-success">Active</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Scraping Modal -->
<div class="modal fade" id="scrapingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-users"></i> Scrape Followers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scraping_form">
                    <div class="mb-3">
                        <label class="form-label">Target Account</label>
                        <input type="text" class="form-control" id="target_account" placeholder="binance">
                        <div class="form-text">Username to scrape followers from (without @)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Max Users</label>
                        <input type="number" class="form-control" id="max_users" value="100" min="10" max="1000">
                        <div class="form-text">Maximum number of followers to scrape (10-1000)</div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" id="start_scraping">
                        <i class="fas fa-play"></i> Start Scraping
                    </button>
                </div>
                
                <div id="scraping_progress" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i> Scraping in progress...
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar" id="scraping_progress_bar" style="width: 0%"></div>
                    </div>
                    <div class="text-center">
                        <span id="scraping_status">Starting...</span>
                    </div>
                    <div class="text-center mt-2">
                        <button type="button" class="btn btn-danger btn-sm" id="stop_scraping">
                            <i class="fas fa-stop"></i> Stop Scraping
                        </button>
                    </div>
                </div>
                
                {% if scraped_accounts %}
                <div class="mt-4">
                    <h6>Previously Scraped Accounts:</h6>
                    <div class="list-group">
                        {% for account in scraped_accounts %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><strong>@{{ account }}</strong></span>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="showUserSelector('{{ account }}')">
                                        <i class="fas fa-filter"></i> Select
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary load-scraped" data-account="{{ account }}">
                                        <i class="fas fa-plus"></i> Load All
                                    </button>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="/download/scraped-users/{{ account }}?format=txt">Download TXT</a></li>
                                            <li><a class="dropdown-item" href="/download/scraped-users/{{ account }}?format=csv">Download CSV</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div id="selector_{{ account }}" class="user-selector" style="display: none;">
                                <div class="row g-2 mb-2">
                                    <div class="col-md-6">
                                        <input type="number" class="form-control form-control-sm" placeholder="How many users?" value="100" id="count_{{ account }}">
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-sm btn-success w-100" onclick="selectFilteredUsers('{{ account }}')">
                                            <i class="fas fa-check"></i> Select Users
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-select all accounts by default
    const checkboxes = document.querySelectorAll('input[name="account_ids"]');
    checkboxes.forEach(cb => cb.checked = true);
    
    const usersInput = document.getElementById('users_input');
    const messageTemplate = document.getElementById('message_template');
    const availableTags = document.getElementById('available_tags');
    const messagePreview = document.getElementById('message_preview');
    
    // Update available tags when users input changes
    function updateAvailableTags() {
        const rawUsers = usersInput.value.split(',').map(u => u.trim()).filter(u => u);
        const users = [...new Set(rawUsers)]; // Remove duplicates
        availableTags.innerHTML = '';
        
        // Update duplicate info
        const duplicatesInfo = document.getElementById('duplicates_info');
        const duplicatesDetails = document.getElementById('duplicates_details');
        const duplicatesCount = rawUsers.length - users.length;
        
        if (duplicatesCount > 0) {
            duplicatesInfo.style.display = 'block';
            duplicatesDetails.textContent = `${duplicatesCount} duplicate users removed`;
        } else {
            duplicatesInfo.style.display = 'none';
        }
        
        // Update batch info
        const batchInfo = document.getElementById('batch_info');
        const batchDetails = document.getElementById('batch_details');
        
        if (users.length > 10) {
            const totalPosts = Math.ceil(users.length / 10);
            batchInfo.style.display = 'block';
            batchDetails.innerHTML = `
                <strong>Batch Campaign:</strong> ${users.length} users will be split into ${totalPosts} posts<br>
                ‚Ä¢ Posts 1-${totalPosts-1}: 10 tags each<br>
                ‚Ä¢ Post ${totalPosts}: ${users.length % 10 || 10} tags<br>
                ‚Ä¢ Estimated time: ${Math.ceil(totalPosts * 1.5)} minutes
            `;
        } else if (users.length > 0) {
            batchInfo.style.display = 'block';
            batchDetails.innerHTML = `<strong>Single Post:</strong> ${users.length} users in one post`;
        } else {
            batchInfo.style.display = 'none';
        }
        
        users.forEach(user => {
            const tag = document.createElement('span');
            tag.className = 'badge bg-primary me-1 mb-1';
            tag.style.cursor = 'pointer';
            tag.textContent = '@' + user;
            tag.draggable = true;
            
            // Drag functionality
            tag.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', '@' + user);
            });
            
            // Click to insert at cursor
            tag.addEventListener('click', function() {
                insertAtCursor(messageTemplate, '@' + user + ' ');
                updatePreview();
            });
            
            availableTags.appendChild(tag);
        });
        
        updatePreview();
    }
    
    // Insert text at cursor position
    function insertAtCursor(textarea, text) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;
        textarea.value = value.substring(0, start) + text + value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + text.length;
        textarea.focus();
    }
    
    // Track used tags
    let usedTags = new Set();
    
    // Update message preview and check for unused tags
    function updatePreview() {
        const users = usersInput.value.split(',').map(u => u.trim()).filter(u => u);
        const messageText = messageTemplate.value;
        
        // Find all @mentions in the message
        const mentionRegex = /@(\w+)/g;
        const foundMentions = new Set();
        let match;
        while ((match = mentionRegex.exec(messageText)) !== null) {
            foundMentions.add(match[1]);
        }
        
        // Handle {TAGS} placeholder
        let preview = messageText;
        if (messageText.includes('{TAGS}')) {
            const tagsText = users.map(u => '@' + u).join(' ');
            preview = messageText.replace('{TAGS}', tagsText);
            // Mark all users as used if {TAGS} is present
            users.forEach(u => foundMentions.add(u));
        }
        
        // Check for unused tags
        const unusedTags = users.filter(u => !foundMentions.has(u));
        if (unusedTags.length > 0) {
            const warningDiv = document.getElementById('unused_warning') || document.createElement('div');
            warningDiv.id = 'unused_warning';
            warningDiv.className = 'alert alert-warning mt-2';
            warningDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Unused tags: ${unusedTags.map(u => '@' + u).join(', ')}`;
            if (!document.getElementById('unused_warning')) {
                messageTemplate.parentNode.appendChild(warningDiv);
            }
        } else {
            const warningDiv = document.getElementById('unused_warning');
            if (warningDiv) warningDiv.remove();
        }
        
        if (!preview.trim()) {
            preview = '<em class="text-muted">Preview will appear here...</em>';
        } else {
            preview = preview.replace(/\n/g, '<br>');
        }
        
        messagePreview.innerHTML = preview;
    }
    
    // Enable drop on textarea
    messageTemplate.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.backgroundColor = '#f8f9fa';
    });
    
    messageTemplate.addEventListener('dragleave', function(e) {
        this.style.backgroundColor = '';
    });
    
    messageTemplate.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.backgroundColor = '';
        const text = e.dataTransfer.getData('text/plain');
        insertAtCursor(this, text + ' ');
        updatePreview();
    });
    
    // Template definitions
    const templates = {
        crypto: `üì¢ Community Update: New project announcement

Thanks for being part of our community! 

üë• Tagging active members: {TAGS}

#Community #Update #Crypto`,
        
        giveaway: `üéÅ Community Appreciation Event

Thank you for your continued support!
Check out this opportunity.

üèÜ Mentioning: {TAGS}

#Community #Appreciation #Event`,
        
        hype: `üìà Interesting development in the space

Thought you might find this relevant.
What are your thoughts?

üí≠ CC: {TAGS}

#Discussion #Crypto #Thoughts`
    };
    
    // Template click handlers
    document.querySelectorAll('.template-card').forEach((card, index) => {
        const templateKeys = ['crypto', 'giveaway', 'hype'];
        const templateKey = templateKeys[index];
        
        card.addEventListener('click', function() {
            // Remove active class from all cards
            document.querySelectorAll('.template-card').forEach(c => {
                c.style.border = '2px solid #e9ecef';
                c.style.backgroundColor = '';
            });
            
            // Highlight selected card
            this.style.border = '2px solid #007bff';
            this.style.backgroundColor = '#f8f9fa';
            
            // Set template text
            messageTemplate.value = templates[templateKey];
            updatePreview();
            updateCharCount(); // Add this line to update character count
        });
        
        // Hover effects
        card.addEventListener('mouseenter', function() {
            if (this.style.border !== '2px solid #007bff') {
                this.style.border = '2px solid #6c757d';
            }
        });
        
        card.addEventListener('mouseleave', function() {
            if (this.style.border !== '2px solid #007bff') {
                this.style.border = '2px solid #e9ecef';
            }
        });
    });
    
    // Add {TAGS} button
    const tagsButton = document.createElement('button');
    tagsButton.type = 'button';
    tagsButton.className = 'btn btn-sm btn-outline-secondary mt-1';
    tagsButton.innerHTML = 'Insert {TAGS} placeholder';
    tagsButton.addEventListener('click', function() {
        insertAtCursor(messageTemplate, '{TAGS}');
        updatePreview();
    });
    messageTemplate.parentNode.insertBefore(tagsButton, messageTemplate.nextSibling);
    
    // Character count update
    function updateCharCount() {
        const count = messageTemplate.value.length;
        const charCountSpan = document.getElementById('char_count');
        charCountSpan.textContent = count;
        
        if (count < 80) {
            charCountSpan.className = 'text-danger';
        } else {
            charCountSpan.className = 'text-success';
        }
    }
    
    // File import functionality
    document.getElementById('import_file_btn').addEventListener('click', function() {
        document.getElementById('file_input').click();
    });
    
    document.getElementById('file_input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const users = [];
                
                content.split('\n').forEach(line => {
                    line = line.trim();
                    if (line && !line.startsWith('#')) {
                        if (line.includes(',')) {
                            users.push(...line.split(',').map(u => u.trim().replace('@', '')).filter(u => u));
                        } else {
                            users.push(line.replace('@', ''));
                        }
                    }
                });
                
                if (users.length > 0) {
                    const currentUsers = usersInput.value ? usersInput.value.split(',').map(u => u.trim()).filter(u => u) : [];
                    const allUsers = [...currentUsers, ...users];
                    usersInput.value = allUsers.join(', ');
                    updateAvailableTags();
                    alert(`Imported ${users.length} users from file`);
                } else {
                    alert('No valid users found in file');
                }
            };
            reader.readAsText(file);
        }
    });
    
    // Scraping functionality
    let scrapingInterval;
    
    document.getElementById('start_scraping').addEventListener('click', function() {
        const targetAccount = document.getElementById('target_account').value.trim();
        const maxUsers = parseInt(document.getElementById('max_users').value);
        
        if (!targetAccount) {
            alert('Please enter a target account');
            return;
        }
        
        // Start scraping
        fetch('/campaign/scrape-followers', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `target_account=${encodeURIComponent(targetAccount)}&max_users=${maxUsers}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('scraping_form').style.display = 'none';
                document.getElementById('scraping_progress').style.display = 'block';
                
                // Start polling for progress
                scrapingInterval = setInterval(checkScrapingProgress, 2000);
            } else {
                alert('Error: ' + data.error);
            }
        });
    });
    
    function checkScrapingProgress() {
        fetch('/api/scraping-status')
        .then(response => response.json())
        .then(data => {
            if (data.is_running) {
                const progress = data.total > 0 ? (data.progress / data.total) * 100 : 0;
                document.getElementById('scraping_progress_bar').style.width = progress + '%';
                document.getElementById('scraping_status').textContent = `Scraped ${data.progress}/${data.total} users`;
            } else {
                clearInterval(scrapingInterval);
                document.getElementById('scraping_progress').style.display = 'none';
                document.getElementById('scraping_form').style.display = 'block';
                alert('Scraping completed!');
                location.reload(); // Refresh to show new scraped account
            }
        });
    }
    
    document.getElementById('stop_scraping').addEventListener('click', function() {
        fetch('/scraping/stop', {method: 'POST'})
        .then(() => {
            clearInterval(scrapingInterval);
            document.getElementById('scraping_progress').style.display = 'none';
            document.getElementById('scraping_form').style.display = 'block';
        });
    });
    
    // Load scraped users
    document.querySelectorAll('.load-scraped').forEach(btn => {
        btn.addEventListener('click', function() {
            const account = this.dataset.account;
            
            fetch(`/api/scraped-users/${account}`)
            .then(response => response.json())
            .then(data => {
                if (data.users && data.users.length > 0) {
                    const currentUsers = usersInput.value ? usersInput.value.split(',').map(u => u.trim()).filter(u => u) : [];
                    const newUsers = data.users.filter(u => !data.targeted.includes(u));
                    const allUsers = [...currentUsers, ...newUsers];
                    usersInput.value = allUsers.join(', ');
                    updateAvailableTags();
                    
                    // Mark as targeted
                    fetch('/api/mark-targeted', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({account_name: account, users: newUsers})
                    });
                    
                    alert(`Loaded ${newUsers.length} new users from @${account}`);
                    document.querySelector('[data-bs-dismiss="modal"]').click();
                } else {
                    alert('No users available for this account');
                }
            });
        });
    });
    
    // User selector functions
    window.showUserSelector = function(account) {
        const selector = document.getElementById(`selector_${account}`);
        selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
    };
    
    window.selectFilteredUsers = function(account) {
        const count = parseInt(document.getElementById(`count_${account}`).value) || 100;
        
        fetch('/api/select-scraped-users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                account_name: account,
                count: count
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const currentUsers = usersInput.value ? usersInput.value.split(',').map(u => u.trim()).filter(u => u) : [];
                const allUsers = [...currentUsers, ...data.users];
                usersInput.value = allUsers.join(', ');
                updateAvailableTags();
                
                // Mark as targeted
                fetch('/api/mark-targeted', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({account_name: account, users: data.users})
                });
                
                alert(`Selected ${data.selected_count} users from @${account} (${data.total_available} available)`);
                document.querySelector('[data-bs-dismiss="modal"]').click();
            } else {
                alert('Error: ' + data.error);
            }
        });
    };
    
    // Event listeners
    usersInput.addEventListener('input', updateAvailableTags);
    messageTemplate.addEventListener('input', function() {
        updatePreview();
        updateCharCount();
    });
    
    // CSS for template emojis
    const style = document.createElement('style');
    style.textContent = `
        .template-emoji {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .template-card:hover {
            transform: translateY(-2px);
            transition: all 0.2s ease;
        }
    `;
    document.head.appendChild(style);
    
    // Account selection functions
    window.selectVerifiedOnly = function() {
        const checkboxes = document.querySelectorAll('input[name="account_ids"]');
        checkboxes.forEach(cb => {
            const label = document.querySelector(`label[for="${cb.id}"]`);
            const hasVerified = label.querySelector('.fa-check-circle');
            cb.checked = hasVerified !== null;
        });
    };
    
    window.selectAllAccounts = function() {
        const checkboxes = document.querySelectorAll('input[name="account_ids"]');
        checkboxes.forEach(cb => cb.checked = true);
    };
    
    window.deselectAllAccounts = function() {
        const checkboxes = document.querySelectorAll('input[name="account_ids"]');
        checkboxes.forEach(cb => cb.checked = false);
    };
    
    // Initial updates
    updateAvailableTags();
    updateCharCount();
});
</script>
{% endblock %}